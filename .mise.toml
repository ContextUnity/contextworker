[tools]
python = "3.13"
uv = "latest"

[env]
_.file = { path = ".env", tools = true }
PYTHON = "$(mise which python)"

[tasks.sync]
description = "Install all dependencies (dev)"
run = "uv sync --dev"

[tasks.lint]
description = "Lint + format-check all code (Ruff)"
run = "uv run ruff check src/ && uv run ruff format --check src/"

[tasks.format]
description = "Format all code (Ruff)"
run = "uv run ruff check --fix src/ && uv run ruff format src/"

[tasks.test]
description = "Run all tests"
run = "uv run python -m pytest tests/ -v"

[tasks.check]
description = "Run all checks (lint + test)"
run = "mise run lint && mise run test"

# ===== Harvester Commands =====

[tasks.harvest]
description = "Run harvester for default project"
run = "uv run python -m contextworker.harvester.run"

[tasks."harvest:project"]
description = "Run harvester for specific project (e.g., mise run harvest:project traverse)"
run = "uv run python -m contextworker.harvester.run --project"

[tasks."harvest:supplier"]
description = "Run harvester for specific supplier (e.g., mise run harvest:supplier traverse vysota)"
run = """
PROJECT=$1
SUPPLIER=$2
uv run python -m contextworker.harvester.run --project $PROJECT --supplier $SUPPLIER
"""

[tasks.sync-images]
description = "Sync product images to CDN"
run = "uv run python -m contextworker.harvester.sync_images"

[tasks."sync-images:dealer"]
description = "Sync images for specific dealer"
run = "uv run python -m contextworker.harvester.sync_images --dealer"

# ===== Agent Commands =====

[tasks.gardener]
description = "Start Gardener scheduler"
run = "uv run python -m contextworker.scheduler --agent gardener"

[tasks.lexicon]
description = "Start Lexicon agent"
run = "uv run python -m contextworker.scheduler --agent lexicon"

[tasks.worker]
description = "Start Temporal worker (all workflows)"
run = "uv run python -m contextworker.worker"


# ===== Utility =====

[tasks.clean]
description = "Clean cache files and build artifacts"
run = """
find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
find . -type f -name "*.pyc" -delete 2>/dev/null || true
find . -type f -name "*.pyo" -delete 2>/dev/null || true
find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
rm -rf .pytest_cache/ .ruff_cache/ build/ dist/ 2>/dev/null || true
"""

[tasks.build]
description = "Build distribution packages"
run = "uv build"
